# 国家試験対策ツール 要件定義書

## 1. プロジェクト概要

### 1.1 目的
国家試験の過去問PDFを活用し、効率的な学習を支援する対策ツールを開発する。

### 1.2 重要な設計方針
**全ての検出・紐付け処理は自動化する。ユーザーによる手動設定は不要。**
- ファイル名から年度・回次・時間帯（午前/午後）・別冊かどうかを自動判別
- 問題文から別冊参照（「別冊No.○」等）を自動検出
- **午前の問題は午前の別冊のみ参照、午後の問題は午後の別冊のみ参照**
- 紐付けエラー時は警告ログを出力し、ユーザーに通知

### 1.3 ターゲットユーザー
国家試験受験者（個人利用）

### 1.4 想定環境
- プラットフォーム: macOS / Windows
- 技術スタック: 任意（推奨: React + Electron または Next.js）
- 最終出力: PDF形式のレポート（NotebookLM等で解析可能な形式）

---

## 2. 入力データ仕様

### 2.1 過去問PDFフォルダ構成
```
過去問フォルダ/
├── 2021_29_gozen.pdf           （第29回 午前の問題）
├── 2021_29_gozen_bessatsu.pdf  （第29回 午前の別冊）
├── 2021_29_gogo.pdf            （第29回 午後の問題）
├── 2021_29_gogo_bessatsu.pdf   （第29回 午後の別冊）
├── 2022_30_gozen.pdf           （第30回 午前の問題）
├── 2022_30_gozen_bessatsu.pdf  （第30回 午前の別冊）
├── 2022_30_gogo.pdf            （第30回 午後の問題）
├── 2022_30_gogo_bessatsu.pdf   （第30回 午後の別冊）
├── 2023_31_gozen.pdf
├── 2023_31_gozen_bessatsu.pdf
├── 2023_31_gogo.pdf
├── 2023_31_gogo_bessatsu.pdf
├── 2024_32_gozen.pdf
├── 2024_32_gozen_bessatsu.pdf
├── 2024_32_gogo.pdf
├── 2024_32_gogo_bessatsu.pdf
├── 2025_33_gozen.pdf
├── 2025_33_gozen_bessatsu.pdf
├── 2025_33_gogo.pdf
└── 2025_33_gogo_bessatsu.pdf
```

### 2.2 ファイル命名規則（重要）
```
命名パターン:
  {年度}_{回次}_{時間帯}.pdf           → 問題PDF
  {年度}_{回次}_{時間帯}_bessatsu.pdf  → 別冊PDF

例:
  2021_29_gozen.pdf          → 2021年度 第29回 午前 問題
  2021_29_gozen_bessatsu.pdf → 2021年度 第29回 午前 別冊
  2021_29_gogo.pdf           → 2021年度 第29回 午後 問題
  2021_29_gogo_bessatsu.pdf  → 2021年度 第29回 午後 別冊

時間帯:
  gozen = 午前
  gogo  = 午後

別冊の判別:
  ファイル名に「_bessatsu」が含まれる → 別冊PDF
  含まれない → 問題PDF

正規表現:
  /(\d{4})_(\d+)_(gozen|gogo)(_bessatsu)?\.pdf/
```

### 2.3 PDFデータの構造（想定）
各問題PDFには以下の情報が含まれる：
- 問題番号
- 問題文
- 選択肢（例: a, b, c, d, e または 1, 2, 3, 4, 5）
- 正解
- 解説

> **実装時の確認事項**: PDFの実際の構造を解析し、問題・選択肢・正解・解説の抽出ロジックを決定する

### 2.4 別冊PDFの役割と構造

別冊は**問題を解くために参照する資料集**（画像・図表・写真・グラフ等）である。

#### 2.4.1 別冊の特徴
- 各回・各時間帯（午前/午後）に1つの別冊PDFが存在
- 問題文中に「別冊No.○を見て答えよ」「別冊の図Aを参照」等の参照指示がある
- 別冊には図番号・資料番号が付与されている（例: No.1、図A、写真1 など）
- 画像・CT画像・X線写真・病理写真・グラフ・表・心電図などが含まれる

#### 2.4.2 別冊と問題の対応関係（重要）
```
★午前の問題 → 午前の別冊のみを参照
★午後の問題 → 午後の別冊のみを参照

例:
  2021_29_gozen.pdf の問題 → 2021_29_gozen_bessatsu.pdf の画像を参照
  2021_29_gogo.pdf の問題  → 2021_29_gogo_bessatsu.pdf の画像を参照

午前の問題が午後の別冊を参照することはない（逆も同様）
```

#### 2.4.3 別冊と問題の紐付けパターン
```
【問題文の例】
「別冊No.5の写真を見て、この所見から考えられる疾患はどれか。」
「別冊の図Aに示す心電図の所見として正しいのはどれか。」
「別冊No.12A、Bを別に示す。診断はどれか。」
```

#### 2.4.4 別冊データ構造
```
別冊PDF構造（想定）:
├── No.1 （画像1枚または複数枚）
├── No.2
├── No.3A, No.3B （関連する複数画像）
├── 図A
├── 図B
└── ... 
```

---

## 3. 機能要件

### 3.1 過去問データ管理機能

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-001 | PDFフォルダ読み込み | 指定フォルダ内の全PDFファイルを一括読み込み |
| F-002 | ファイル名自動解析 | ファイル名から年度・回次・時間帯・別冊有無を自動判別 |
| F-003 | 問題データ抽出 | PDFから問題文・選択肢・正解・解説を構造化データとして抽出 |
| F-004 | データベース保存 | 抽出した問題データをローカルDB（SQLiteなど）に保存 |

### 3.2 別冊管理機能

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-011 | 別冊画像抽出 | 別冊PDFから全画像・図表を抽出し保存 |
| F-012 | 別冊番号認識 | 各画像に付与された番号（No.1、図A等）を自動認識 |
| F-013 | 問題-別冊紐付け | 問題文から別冊参照を検出し、対応する画像と紐付け |
| F-014 | 参照パターン解析 | 「別冊No.○」「別冊の図○」等の参照パターンを正規表現で検出 |
| F-015 | 複数画像対応 | 1問に複数の別冊画像が紐付く場合に対応（例: No.5A, No.5B） |
| F-016 | 別冊なし問題判別 | 別冊参照がない問題を識別し、画像なしで出題 |

#### 別冊参照パターン（検出対象）
```
検出すべきパターン例:
- 「別冊No.○」「別冊No.○○」
- 「別冊の図○」「別冊の表○」
- 「別冊No.○A」「別冊No.○B」（複数画像）
- 「別冊No.○A、○B」「別冊No.○A〜C」
- 「別冊を参照」（番号なしの場合も考慮）
```

---

## 4. 自動検出・紐付けアルゴリズム（最重要）

**Cursor側で全て自動処理する。ユーザーによる手動紐付けは不要。**

### 4.1 STEP 1: ファイル名からメタ情報を自動抽出

```
ファイル名パターンと抽出結果:

  2021_29_gozen.pdf
  → { year: 2021, examNumber: 29, session: 'gozen', type: 'question' }

  2021_29_gozen_bessatsu.pdf
  → { year: 2021, examNumber: 29, session: 'gozen', type: 'supplement' }

  2021_29_gogo.pdf
  → { year: 2021, examNumber: 29, session: 'gogo', type: 'question' }

  2021_29_gogo_bessatsu.pdf
  → { year: 2021, examNumber: 29, session: 'gogo', type: 'supplement' }

正規表現:
  /(\d{4})_(\d+)_(gozen|gogo)(_bessatsu)?\.pdf/
  
  グループ1: 年度（2021, 2022, ...）
  グループ2: 回次（29, 30, 31, 32, 33）
  グループ3: 時間帯（gozen = 午前, gogo = 午後）
  グループ4: _bessatsu があれば別冊、なければ問題

抽出結果の型:
  - year: number        // 年度
  - examNumber: number  // 回次
  - session: 'gozen' | 'gogo'  // 午前 or 午後
  - type: 'question' | 'supplement'  // 問題 or 別冊
```

### 4.2 STEP 2: 問題PDFの解析

```
対象ファイル: _bessatsu が含まれないPDF（問題PDF）

各問題PDFから以下を抽出:
  1. 問題番号（問1、問2...または連番）
  2. 問題文テキスト
  3. 選択肢（a〜e または 1〜5）
  4. 正解
  5. 解説

問題ごとにメタ情報を付与:
  {
    year: 2021,            // ファイル名から取得
    examNumber: 29,        // ファイル名から取得
    session: 'gozen',      // ファイル名から取得（午前 or 午後）
    questionNumber: 15,    // PDF内から抽出
    questionText: "別冊No.5を見て...",
    choices: [...],
    correctAnswer: "c",
    explanation: "..."
  }
```

### 4.3 STEP 3: 別冊PDFの解析

```
対象ファイル: _bessatsu が含まれるPDF（別冊PDF）

別冊PDFから以下を抽出:
  1. 全ページの画像を抽出
  2. 各画像の番号を認識（OCRまたはテキスト抽出）
  3. 回次・時間帯情報を付与（ファイル名から）

画像ごとにメタ情報を付与:
  {
    year: 2021,            // ファイル名から取得
    examNumber: 29,        // ファイル名から取得
    session: 'gozen',      // ファイル名から取得（午前 or 午後）
    imageNumber: "12A",    // PDF内から抽出（No.12A、図A など）
    imageData: "...",      // Base64 or ファイルパス
    sourcePage: 5          // 別冊PDF内のページ番号
  }
```

### 4.4 STEP 4: 問題文からの別冊参照検出

```
正規表現パターン（複数対応）:
  /別冊\s*(No\.?|の図|の表|の写真)?\s*(\d+)\s*([A-Za-z])?/g
  /別冊\s*(No\.?)?\s*(\d+)\s*([A-Za-z])?\s*[、,]\s*([A-Za-z])/g

検出例:
  「別冊No.12を見て答えよ」      → ["12"]
  「別冊No.5A、Bを別に示す」     → ["5A", "5B"]
  「別冊の図3を参照」            → ["図3"]
  「別冊No.8A、B、Cを別に示す」  → ["8A", "8B", "8C"]
```

### 4.5 STEP 5: 自動紐付けロジック（最重要）

```
紐付けルール（3条件すべてが一致で紐付け）:

  ┌─────────────────────────────────────────────────────────────┐
  │ 条件1: examNumber が一致（同じ回）                          │
  │ 条件2: session が一致（午前→午前別冊、午後→午後別冊）       │
  │ 条件3: imageNumber が一致（問題文から検出した番号）         │
  └─────────────────────────────────────────────────────────────┘

★重要ルール:
  午前の問題（session: 'gozen'）は午前の別冊のみ参照
  午後の問題（session: 'gogo'）は午後の別冊のみ参照

具体例:
  問題ファイル: 2021_29_gogo.pdf（第29回 午後）
  問題データ:
    {
      examNumber: 29,
      session: 'gogo',
      questionNumber: 48,
      questionText: "別冊No.12A、Bを別に示す。診断はどれか。"
    }
  
  検出される参照: ["12A", "12B"]
  
  紐付け対象を検索（3条件すべて一致）:
    - examNumber: 29 AND session: 'gogo' AND imageNumber: "12A"
    - examNumber: 29 AND session: 'gogo' AND imageNumber: "12B"
  
  → 別冊ファイル 2021_29_gogo_bessatsu.pdf から該当画像を取得
  
  紐付け結果:
    問題.supplementReferences = [
      { imageNumber: "12A", supplementId: "29-gogo-12A" },
      { imageNumber: "12B", supplementId: "29-gogo-12B" }
    ]

NGパターン（紐付けされない）:
  午後の問題が午前の別冊を参照しようとしても、session が一致しないため紐付けされない
  → 紐付けエラーとして警告ログに出力
```

### 4.6 STEP 6: 紐付け結果の検証

```
自動チェック項目:
  □ 参照があるのに対応画像が見つからない → 警告ログ出力
  □ 同じ回次・時間帯で重複する画像番号がある → エラーログ出力
  □ 別冊画像が1つも紐付かない問題 → 別冊なし問題として正常処理

エラー時の動作:
  - 処理は続行（スキップしない）
  - 管理画面またはコンソールに警告を表示
  - ユーザーが手動確認できるようログを残す
```

### 4.7 処理フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                    PDFフォルダ読み込み                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  ファイル名解析（正規表現）                                     │
│  /(\d{4})_(\d+)_(gozen|gogo)(_bessatsu)?\.pdf/                  │
│  → year, examNumber, session, type を抽出                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                                           ↓
┌───────────────────────┐                 ┌───────────────────────┐
│  問題PDF解析          │                 │  別冊PDF解析          │
│  (gozen/gogo)         │                 │  (gozen/gogo_bessatsu)│
├───────────────────────┤                 ├───────────────────────┤
│ - 問題番号抽出        │                 │ - 画像抽出            │
│ - 問題文抽出          │                 │ - 画像番号認識        │
│ - 選択肢抽出          │                 │ - year付与            │
│ - 正解・解説抽出      │                 │ - examNumber付与      │
│ - year付与            │                 │ - session付与         │
│ - examNumber付与      │                 │   (gozen or gogo)     │
│ - session付与         │                 │                       │
│   (gozen or gogo)     │                 │                       │
└───────────────────────┘                 └───────────────────────┘
        ↓                                           ↓
        └─────────────────────┬─────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  別冊参照検出 & 自動紐付け                                      │
│  ─────────────────────────────────────────────────────────────  │
│  1. 問題文から「別冊No.○」を正規表現で検出                     │
│  2. 同じ examNumber AND 同じ session の別冊画像を検索          │
│  3. imageNumber が一致する画像を紐付け                         │
│                                                                 │
│  ★午前(gozen)の問題 → 午前(gozen)の別冊のみ紐付け              │
│  ★午後(gogo)の問題 → 午後(gogo)の別冊のみ紐付け                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  紐付け結果検証 & データベース保存                              │
│  ─────────────────────────────────────────────────────────────  │
│  - 紐付けエラーの検出・ログ出力                                 │
│  - 問題データ + 別冊参照情報を保存                              │
│  - 別冊画像データを保存                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  出題時: 問題表示と同時に紐付いた別冊画像を自動表示             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. モード選択機能

本ツールには**学習モード**と**テストモード**の2つのモードがある。

### 5.1 モード比較表

| 項目 | 学習モード | テストモード |
|------|-----------|-------------|
| 目的 | 理解を深める学習 | 本番を想定した実力測定 |
| 時間計測 | 1問ごとの回答時間を計測 | 全体の制限時間（問題数×75秒） |
| ヒント機能 | あり（ボタンで表示） | なし |
| 正誤判定タイミング | 1問ごと + レポート画面 | 最後にまとめて表示 |
| 解説表示 | 1問ごとに表示 | 最後にまとめて表示（不正解のみ） |
| 時間切れ | なし | 強制的にレポート画面へ移行 |

---

## 6. 学習モード仕様

### 6.1 学習モードの特徴

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-L01 | 時間計測方式 | 1問ごとに回答時間を計測（制限時間なし） |
| F-L02 | ヒント表示 | 「ヒントを見る」ボタンでキーワード・ヒントを表示 |
| F-L03 | 即時フィードバック | 回答後すぐに正誤判定・正解・解説を表示 |
| F-L04 | レポート画面 | 全問終了後に総合結果と全問題の詳細を表示 |
| F-L05 | 自動遷移 | 回答選択後、正誤表示→1秒後に自動で次の問題へ |

### 6.2 キーワード・ヒント機能

#### 6.2.1 抽出元
```
キーワード・ヒントは以下の両方から自動抽出する：
  1. 問題文
  2. 解説文

抽出ロジック:
  - 医学用語・専門用語を優先的に抽出
  - 問題を解く上で重要な概念・キーワードを特定
  - 解説文から正解に導くヒントとなるフレーズを抽出
```

#### 6.2.2 表示方法
```
┌─────────────────────────────────────────┐
│  【第29回 午前 問15】                    │
│                                         │
│  問題文...                              │
│                                         │
│  ┌─────────────────────────────┐        │
│  │  [ 💡 ヒントを見る ]        │ ← 目立つ位置に配置
│  └─────────────────────────────┘        │
│                                         │
│  ○ a. 選択肢1                           │
│  ○ b. 選択肢2                           │
│  ...                                    │
└─────────────────────────────────────────┘

ボタン押下後:
┌─────────────────────────────────────────┐
│  💡 ヒント                              │
│  ─────────────────────────────          │
│  【キーワード】                          │
│  ・急性膵炎                             │
│  ・アミラーゼ上昇                        │
│  ・Cullen徴候                           │
│                                         │
│  【ヒント】                              │
│  ・腹痛の部位と性状に注目               │
│  ・血液検査の異常値を確認               │
└─────────────────────────────────────────┘
```

### 6.3 学習モードの回答フロー

```
1. 問題表示
   ↓
2. ユーザーが回答を選択（任意でヒントを見る）
   ↓
3. 選択肢をクリックした瞬間に回答確定
   ↓
4. 即座に正誤判定を表示
   - 正解の場合: ✓ 正解！（緑色表示）
   - 不正解の場合: ✗ 不正解（赤色表示）+ 正解を表示
   ↓
5. 1秒間表示を維持
   ↓
6. 自動的に次の問題へ遷移
   ↓
7. 2に戻る（繰り返し）
   ↓
8. 全問終了後、レポート画面へ

※ 学習モードでは解説はレポート画面でまとめて確認
※ 「次へ」ボタンは不要（自動遷移のため）
```

### 6.4 学習モードの時間計測

```
計測方式:
  - 問題が表示された瞬間からタイマー開始
  - 「回答する」ボタンを押した瞬間でタイマー停止
  - 1問ごとの回答時間を記録

表示:
  - 画面上部に経過時間をリアルタイム表示（例: 00:45）
  - 解説表示中は時間計測を停止

レポート:
  - 各問題の回答時間を記録
  - 総回答時間、平均回答時間を算出
```

---

## 7. テストモード仕様

### 7.1 テストモードの特徴

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-T01 | 制限時間方式 | 全体の制限時間 = 問題数 × 75秒 |
| F-T02 | カウントダウン | 残り時間を常に表示、時間経過で色変化 |
| F-T03 | 時間切れ処理 | 制限時間0で強制的にレポート画面へ移行 |
| F-T04 | 未回答カウント | 未回答問題は「未回答」として別カウント |
| F-T05 | まとめて結果表示 | 全問終了後（または時間切れ後）に結果表示 |
| F-T06 | ヒント非表示 | テストモードではヒント機能は使用不可 |
| F-T07 | スキップ機能 | 問題をスキップして次へ進める |
| F-T08 | 自動遷移 | 回答選択後、正誤表示→0.5〜1秒後に自動で次の問題へ |

### 7.2 スキップ機能

```
スキップの仕様:
  - 各問題画面に「スキップ」ボタンを配置
  - スキップした問題は回答せずに次の問題へ進む
  - スキップした問題は「スキップ（未回答）」として記録
  - 制限時間内に全問通過しても、スキップした問題は未回答扱い

スキップと未回答の違い:
  - スキップ: ユーザーが意図的に飛ばした問題
  - 時間切れ未回答: 制限時間終了時に到達できなかった問題

レポート表示:
  - スキップ: ⏭ スキップ（未回答）
  - 時間切れ: ⏱ 時間切れ（未回答）

正答率計算:
  正答率 = 正答数 ÷ (総問題数 - スキップ数 - 時間切れ未回答数) × 100
```

### 7.3 制限時間の計算

```
制限時間 = 問題数 × 75秒

例:
  10問の場合: 10 × 75秒 = 750秒 = 12分30秒
  30問の場合: 30 × 75秒 = 2250秒 = 37分30秒
  50問の場合: 50 × 75秒 = 3750秒 = 62分30秒（1時間2分30秒）
  100問の場合: 100 × 75秒 = 7500秒 = 125分（2時間5分）
```

### 7.4 残り時間の表示

```
表示位置: 問題画面の右上（常に表示）

┌─────────────────────────────────────────────────────────────┐
│  第 15 問 / 50 問                    残り時間: 45:30       │
│                                              ↑             │
│                                      色が変化する          │
└─────────────────────────────────────────────────────────────┘

色の変化ルール:
  残り時間 > 50%  → 緑色（安全）
  残り時間 25-50% → 黄色（注意）
  残り時間 10-25% → オレンジ（警告）
  残り時間 < 10%  → 赤色（危険）+ 点滅アニメーション

例（50問 = 62分30秒の場合）:
  残り 31分15秒以上 → 緑
  残り 15分37秒〜31分14秒 → 黄色
  残り 6分15秒〜15分36秒 → オレンジ
  残り 6分14秒以下 → 赤 + 点滅
```

### 7.5 テストモードの回答フロー

```
1. テスト開始（タイマースタート）
   ↓
2. 問題表示
   ↓
3. ユーザーが選択肢をクリック または 「スキップ」ボタンをクリック
   ↓
   ┌─────────────────────────────────────────────┐
   │ 選択肢をクリックした場合:                    │
   │   → 即座に正誤判定を表示（0.5秒間）         │
   │   → 正解: ✓（緑色）/ 不正解: ✗（赤色）    │
   │   → 0.5秒後に自動で次の問題へ              │
   ├─────────────────────────────────────────────┤
   │ スキップをクリックした場合:                  │
   │   → 「スキップしました」を表示（0.3秒間）   │
   │   → 即座に次の問題へ                        │
   └─────────────────────────────────────────────┘
   ↓
4. 次の問題へ（2に戻る）
   ↓
5. 全問通過 または 制限時間終了
   ↓
6. レポート画面へ移行

※ テストモードでは解説は最後にまとめて表示
※ 「次へ」ボタンは不要（自動遷移のため）
※ スキップした問題は未回答としてカウント
```

### 7.6 時間切れ時の処理

```
制限時間が0になった瞬間:
  1. 回答中の問題があれば、未選択のまま終了
  2. 未到達の問題は「時間切れ（未回答）」として記録
  3. スキップした問題は「スキップ（未回答）」として記録
  4. 自動的にレポート画面へ強制移行
  5. 「時間切れにより終了しました」のメッセージを表示

未回答の種類:
  - スキップ ⏭: ユーザーが意図的に飛ばした
  - 時間切れ ⏱: 制限時間内に到達できなかった

正答率の計算:
  回答済み問題数 = 総問題数 - スキップ数 - 時間切れ未回答数
  正答率 = 正答数 ÷ 回答済み問題数 × 100

レポート表示:
  - スキップ: ○問
  - 時間切れ未回答: ○問
  - 合計未回答: ○問
```

### 7.7 テストモードのレポート画面

```
┌─────────────────────────────────────────────────────────────┐
│                    テスト結果                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ■ 総合成績                                                 │
│                                                             │
│  総問題数:      50 問                                       │
│  正答数:        38 問                                       │
│  誤答数:         8 問                                       │
│  スキップ:       2 問  ⏭                                   │
│  時間切れ未回答: 2 問  ⏱                                   │
│  正答率:        82.6 %  ※ 38÷46（回答済み問題数）          │
│                                                             │
│  ─────────────────────────────────────                      │
│                                                             │
│  ⏱ 制限時間: 62分30秒                                      │
│  ✓ 残り時間: 8分45秒 で完了！                               │
│    （または「時間切れにより終了」）                          │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ■ 詳細結果                                                 │
│                                                             │
│  【第1問】第29回 午前 問15  ✓ 正解                          │
│  あなたの回答: c  正解: c                                   │
│                                                             │
│  【第2問】第29回 午前 問16  ✗ 不正解                        │
│  あなたの回答: b  正解: d                                   │
│  ─────────────────────────────                              │
│  📖 解説:                                                   │
│  この問題は○○についての問題です。                          │
│  △△の特徴として正しいのは...                               │
│  ─────────────────────────────                              │
│                                                             │
│  【第3問】第29回 午後 問3  ⏭ スキップ（未回答）            │
│  正解: a                                                    │
│  ─────────────────────────────                              │
│  📖 解説:                                                   │
│  この問題はスキップされたため未回答です。                   │
│  正解は a で、理由は...                                     │
│  ─────────────────────────────                              │
│                                                             │
│  【第49問】第31回 午後 問22  ⏱ 時間切れ（未回答）          │
│  正解: c                                                    │
│  ─────────────────────────────                              │
│  📖 解説:                                                   │
│  制限時間内に到達できませんでした。                         │
│  正解は c で、...                                           │
│  ─────────────────────────────                              │
│                                                             │
│  ... (以下続く)                                             │
│                                                             │
│          [ PDFで保存 ]  [ ホームに戻る ]                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘

表示ルール:
  - 正解 ✓: 解説なし
  - 不正解 ✗: 解説あり
  - スキップ ⏭: 「スキップされたため未回答」+ 解説あり
  - 時間切れ ⏱: 「制限時間内に到達できませんでした」+ 解説あり
```

### 7.8 残り時間の表示（制限時間内完了の場合）

```
制限時間内に全問回答できた場合:
  - 「制限時間の残りは○分○秒で完了しました！」を表示
  - 残り時間が多いほど良い成績として強調表示

例:
  制限時間 62分30秒、使用時間 53分45秒 の場合
  → 「✓ 残り時間: 8分45秒 で完了！」

制限時間切れの場合:
  → 「⏱ 時間切れにより終了しました」
```

---

## 8. 出題設定機能

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-101 | モード選択 | 学習モード or テストモードを選択 |
| F-102 | 回次フィルター | 特定の回のみ出題（例: 「第29回のみ」「第30回のみ」） |
| F-103 | 時間帯フィルター | 午前/午後の指定（複数選択可） |
| F-104 | 複数回選択 | 複数の回を組み合わせて出題（例: 第29回+第30回） |
| F-105 | 全問題モード | 全ての問題からランダム出題 |
| F-106 | 出題数カスタム | ユーザーが任意の問題数を指定（例: 10問、30問、50問、100問） |
| F-107 | ランダム出題 | 選択された範囲から指定数をランダムに抽出 |
| F-108 | 出題順シャッフル | 問題の出題順をランダム化（オプション） |

---

## 9. 問題解答機能

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-201 | 問題表示 | 1問ずつ問題文と選択肢を表示 |
| F-202 | 回答選択 | ユーザーが選択肢をクリック/タップして回答確定 |
| F-203 | 自動遷移 | 回答後、正誤表示→自動で次の問題へ（学習:1秒、テスト:0.5秒） |
| F-204 | 問題番号表示 | 「第○問 / 全○問」の進捗表示 |
| F-205 | 中断・再開 | セッション途中での中断と再開機能（オプション） |
| F-206 | 別冊画像表示 | 別冊参照がある問題では、該当画像を問題文と一緒に表示 |
| F-207 | 画像拡大機能 | 別冊画像をクリックで拡大表示（モーダル/ライトボックス） |
| F-208 | 複数画像切替 | 複数画像（A, B, C等）がある場合はタブまたはスライドで切替 |
| F-209 | 画像ズーム | ピンチズーム・スクロールズームで画像の詳細確認 |
| F-210 | スキップ機能 | テストモードのみ：問題をスキップして次へ（未回答扱い） |

### 自動遷移の仕様
```
選択肢クリック時の動作:

【学習モード】
  1. 選択肢をクリック → 回答確定
  2. 即座に正誤判定を表示
     - 正解: ✓ 正解！（緑色背景）
     - 不正解: ✗ 不正解（赤色背景）+ 正解を表示
  3. 1秒間表示を維持
  4. 自動的に次の問題へ遷移
  
【テストモード】
  1. 選択肢をクリック → 回答確定
  2. 即座に正誤判定を表示
     - 正解: ✓（緑色）
     - 不正解: ✗（赤色）
  3. 0.5秒間表示を維持
  4. 自動的に次の問題へ遷移

【スキップ（テストモードのみ）】
  1. 「スキップ」ボタンをクリック
  2. 「⏭ スキップしました」を表示（0.3秒）
  3. 即座に次の問題へ遷移
  4. この問題は「スキップ（未回答）」として記録

※ 「次へ」ボタンは不要（全て自動遷移）
※ 解説は最後のレポート画面でまとめて確認
```

### 別冊画像の表示ルール
```
1. 問題文を解析し、別冊参照を検出
2. 参照がある場合:
   - 問題文の上部または横に別冊画像を表示
   - 「別冊 No.5」等のキャプション付き
   - 画像クリックで拡大モーダル表示
3. 参照がない場合:
   - 画像エリアは非表示
   - 問題文・選択肢のみの標準レイアウト
4. 複数画像の場合:
   - タブ形式で「No.5A | No.5B」と切替可能
   - または横並び/縦並びで同時表示（設定可能）
```

---

## 10. 時間計測機能（モード共通）

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-301 | 問題別時間計測 | 各問題の表示から回答までの時間を計測 |
| F-302 | 秒単位記録 | 回答時間は秒単位で記録（例: 30秒、90秒） |
| F-303 | リアルタイム表示 | 回答中の経過時間をリアルタイム表示（オプション） |
| F-304 | 総回答時間計測 | 全問題の合計回答時間を計測 |

---

## 11. 結果集計機能

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-401 | 総出題数表示 | 出題された問題の総数 |
| F-402 | 正答数表示 | 正解した問題の数 |
| F-403 | 誤答数表示 | 不正解だった問題の数 |
| F-404 | 正答率計算 | 正答率をパーセンテージで表示（小数点第1位まで） |
| F-405 | 総回答時間表示 | 全問題の合計回答時間（○分○秒形式） |
| F-406 | 平均回答時間 | 1問あたりの平均回答時間 |

---

## 12. 詳細レポート機能

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-501 | 問題別結果表示 | 各問題について以下を表示 |
| F-502 | 問題情報 | 問題番号、出典（第○回/午前or午後）、問題文 |
| F-503 | ユーザー回答 | ユーザーが選択した選択肢 |
| F-504 | 正誤判定 | 「正解」または「不正解」の表示 |
| F-505 | 正解表示 | 不正解の場合、正しい選択肢を表示 |
| F-506 | 解説表示 | PDFから抽出した解説文を表示 |
| F-507 | 回答時間表示 | その問題にかかった時間（○分○秒形式） |

---

## 13. PDF出力機能

| ID | 機能名 | 詳細 |
|----|--------|------|
| F-601 | レポートPDF生成 | 結果レポートをPDF形式で出力 |
| F-602 | 1ページレイアウト | 全結果を1ページに収めたコンパクトなレイアウト |
| F-603 | 印刷対応 | macOSの印刷機能（⌘+P）でPDF保存可能 |
| F-604 | NotebookLM対応 | テキスト抽出可能なPDF形式（画像埋め込みではなくテキストベース） |
| F-605 | ファイル名自動生成 | 日時を含むファイル名（例: 結果_2024-01-15_143052.pdf） |

---

## 14. 画面設計（ワイヤーフレーム概要）

### 14.1 ホーム画面
```
┌─────────────────────────────────────────┐
│           国家試験対策ツール             │
├─────────────────────────────────────────┤
│                                         │
│  [ 過去問フォルダを選択 ]                │
│                                         │
│  読み込み済み: 第29回〜第33回            │
│  総問題数: ○○○問                       │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  ■ モード選択                           │
│                                         │
│  ┌─────────────┐  ┌─────────────┐       │
│  │  📚 学習    │  │  📝 テスト  │       │
│  │  モード     │  │  モード     │       │
│  │             │  │             │       │
│  │ ヒント機能  │  │ 制限時間    │       │
│  │ 即時解説   │  │ 本番形式    │       │
│  └─────────────┘  └─────────────┘       │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  ■ 出題設定                             │
│                                         │
│  回次選択:                              │
│  □ 第29回  □ 第30回  □ 第31回          │
│  □ 第32回  □ 第33回  □ 全て            │
│                                         │
│  時間帯選択:                            │
│  □ 午前  □ 午後  □ 全て                │
│                                         │
│  出題数: [ 50 ▼ ] 問                    │
│                                         │
│  □ 出題順をシャッフルする               │
│                                         │
│  ─────────────────────────────          │
│  テストモード選択時のみ表示:            │
│  ⏱ 制限時間: 62分30秒（50問 × 75秒）   │
│  ─────────────────────────────          │
│                                         │
│          [ 学習を開始する ]              │
│                                         │
└─────────────────────────────────────────┘
```

### 14.2 問題画面（学習モード・別冊なし）
```
┌─────────────────────────────────────────┐
│  第 15 問 / 50 問      経過時間: 00:45   │
├─────────────────────────────────────────┤
│  【第29回 午前 問15】    📚 学習モード   │
│                                         │
│  問題文がここに表示される。              │
│  複数行にわたる場合も対応。              │
│                                         │
│  ┌─────────────────────────────┐        │
│  │  [ 💡 ヒントを見る ]        │        │
│  └─────────────────────────────┘        │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  ○ a. 選択肢1    ← クリックで即回答確定 │
│  ○ b. 選択肢2                           │
│  ○ c. 選択肢3                           │
│  ○ d. 選択肢4                           │
│  ○ e. 選択肢5                           │
│                                         │
│  ※ 選択すると正誤表示後、自動で次へ     │
│                                         │
└─────────────────────────────────────────┘
```

### 14.3 問題画面（学習モード・回答後 → 自動遷移）
```
┌─────────────────────────────────────────┐
│  第 15 問 / 50 問      回答時間: 00:45   │
├─────────────────────────────────────────┤
│  【第29回 午前 問15】    📚 学習モード   │
│                                         │
│  問題文がここに表示される。              │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  ○ a. 選択肢1                           │
│  ○ b. 選択肢2                           │
│  ● c. 選択肢3  ← あなたの回答          │
│  ◉ d. 選択肢4  ✓ 正解                  │
│  ○ e. 選択肢5                           │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │  ✗ 不正解！ 正解は d です       │    │
│  │                                 │    │
│  │  → 1秒後に自動で次の問題へ      │    │
│  └─────────────────────────────────┘    │
│                                         │
└─────────────────────────────────────────┘

※ 1秒間表示後、自動的に次の問題へ遷移
※ 解説はレポート画面でまとめて確認
```

### 14.4 問題画面（テストモード）
```
┌─────────────────────────────────────────┐
│  第 15 問 / 50 問      残り時間: 45:30   │
│                               ↑ 緑色    │
├─────────────────────────────────────────┤
│  【第29回 午前 問15】    📝 テストモード │
│                                         │
│  問題文がここに表示される。              │
│  複数行にわたる場合も対応。              │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  ○ a. 選択肢1    ← クリックで即回答確定 │
│  ○ b. 選択肢2                           │
│  ○ c. 選択肢3                           │
│  ○ d. 選択肢4                           │
│  ○ e. 選択肢5                           │
│                                         │
│  ─────────────────────────────          │
│  [ ⏭ スキップ ]                         │
│                                         │
│  ※ 選択すると正誤表示後、自動で次へ     │
│                                         │
└─────────────────────────────────────────┘

※ テストモードでは:
  - ヒントボタンなし
  - スキップボタンあり
  - 選択後0.5秒で自動遷移
  - 残り時間が減ると色が変化（緑→黄→オレンジ→赤）
```

### 14.5 問題画面（テストモード・回答後 → 自動遷移）
```
┌─────────────────────────────────────────┐
│  第 15 問 / 50 問      残り時間: 45:28   │
├─────────────────────────────────────────┤
│  【第29回 午前 問15】    📝 テストモード │
│                                         │
│  問題文がここに表示される。              │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  ○ a. 選択肢1                           │
│  ○ b. 選択肢2                           │
│  ● c. 選択肢3  ← あなたの回答 ✗        │
│  ◉ d. 選択肢4  ← 正解 ✓                │
│  ○ e. 選択肢5                           │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │  ✗ 不正解                        │    │
│  └─────────────────────────────────┘    │
│                                         │
│  → 0.5秒後に自動で次の問題へ            │
│                                         │
└─────────────────────────────────────────┘

※ 0.5秒間表示後、自動的に次の問題へ遷移
```

### 14.6 問題画面（テストモード・残り時間少）
```
┌─────────────────────────────────────────┐
│  第 42 問 / 50 問      残り時間: 03:45   │
│                         ↑ 赤色+点滅     │
├─────────────────────────────────────────┤
│  【第31回 午後 問22】    📝 テストモード │
│                                         │
│  問題文がここに表示される。              │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  ○ a. 選択肢1                           │
│  ○ b. 選択肢2                           │
│  ○ c. 選択肢3                           │
│  ○ d. 選択肢4                           │
│  ○ e. 選択肢5                           │
│                                         │
│  ─────────────────────────────          │
│  [ ⏭ スキップ ]                         │
│                                         │
└─────────────────────────────────────────┘
```

### 14.7 問題画面（学習モード・別冊あり）
```
┌─────────────────────────────────────────────────────────────┐
│  第 23 問 / 50 問                        経過時間: 01:15    │
├─────────────────────────────────────────────────────────────┤
│  【第30回 午後 問48】                                       │
│                                                             │
│  ┌─────────────────────────────┐                            │
│  │                             │                            │
│  │    【別冊 No.12】           │                            │
│  │                             │                            │
│  │   ┌───────────────────┐    │                            │
│  │   │                   │    │                            │
│  │   │   (CT画像など)    │    │  ← クリックで拡大          │
│  │   │                   │    │                            │
│  │   └───────────────────┘    │                            │
│  │                             │                            │
│  │   [ No.12A ] [ No.12B ]    │  ← 複数画像はタブ切替      │
│  │                             │                            │
│  └─────────────────────────────┘                            │
│                                                             │
│  別冊No.12A、Bを別に示す。                                  │
│  この患者の診断として最も考えられるのはどれか。             │
│                                                             │
│  ─────────────────────────────────────                      │
│                                                             │
│  ○ a. 急性虫垂炎                                           │
│  ○ b. 急性膵炎                                             │
│  ○ c. 腸閉塞                                               │
│  ○ d. 大腸癌                                               │
│  ○ e. 胆石症                                               │
│                                                             │
│                    [ 回答して次へ → ]                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 14.8 画像拡大モーダル
```
┌─────────────────────────────────────────────────────────────┐
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │                                                     │   │
│  │                                                     │   │
│  │              (拡大された別冊画像)                   │   │
│  │                                                     │   │
│  │                                                     │   │
│  │                                                     │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  【別冊 No.12A】 CT画像（腹部）                             │
│                                                             │
│  [ ← 前 ]  [ No.12A ] [ No.12B ]  [ 次 → ]    [ ✕ 閉じる ] │
│                                                             │
│  ズーム: [ - ] ████████░░ [ + ]   [ リセット ]             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 14.9 結果サマリー画面（学習モード）
```
┌─────────────────────────────────────────┐
│              学習結果                    │
├─────────────────────────────────────────┤
│                                         │
│  ■ 総合成績                             │
│                                         │
│  総出題数:    50 問                     │
│  正答数:      38 問                     │
│  誤答数:      12 問                     │
│  正答率:      76.0 %                    │
│                                         │
│  総回答時間:  25分30秒                  │
│  平均回答時間: 30.6秒/問                │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  [ 詳細レポートを見る ]                  │
│  [ PDFで保存 ]                          │
│  [ ホームに戻る ]                        │
│                                         │
└─────────────────────────────────────────┘
```

### 14.10 結果画面（テストモード）
```
┌─────────────────────────────────────────────────────────────┐
│                    テスト結果                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ■ 総合成績                                                 │
│                                                             │
│  総問題数:    50 問                                         │
│  正答数:      38 問                                         │
│  誤答数:      10 問                                         │
│  未回答:       2 問                                         │
│  正答率:      79.2 %  ※(38÷48)×100                         │
│                                                             │
│  ─────────────────────────────────────                      │
│                                                             │
│  ⏱ 制限時間: 62分30秒                                      │
│  ✓ 残り時間: 8分45秒 で完了！                               │
│                                                             │
│  ─────────────────────────────────────                      │
│                                                             │
│  ■ 詳細結果                                                 │
│                                                             │
│  【第1問】第29回 午前 問15  ✓ 正解                          │
│  あなたの回答: c  正解: c                                   │
│                                                             │
│  【第2問】第29回 午前 問16  ✗ 不正解                        │
│  あなたの回答: b  正解: d                                   │
│  ─────────────────────────────                              │
│  📖 解説:                                                   │
│  この問題は○○についての問題です。                          │
│  △△の特徴として正しいのは...                               │
│  ─────────────────────────────                              │
│                                                             │
│  【第3問】第29回 午後 問3  ⚠ 未回答                         │
│  正解: a                                                    │
│  ─────────────────────────────                              │
│  📖 解説:                                                   │
│  ...                                                        │
│                                                             │
│  ... (以下続く)                                             │
│                                                             │
│          [ PDFで保存 ]  [ ホームに戻る ]                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘

※ 表示ルール:
  - 正解 ✓ → 解説なし
  - 不正解 ✗ → 解説あり
  - 未回答 ⚠ → 解説あり
```

### 14.11 詳細レポート画面（学習モード）
```
┌─────────────────────────────────────────┐
│           詳細レポート                   │
├─────────────────────────────────────────┤
│                                         │
│  ■ 第1問【第29回 午前】 ✓ 正解          │
│  回答時間: 25秒                         │
│  ─────────────────────────────          │
│  問題: ○○について正しいものはどれか     │
│  あなたの回答: c                        │
│  正解: c                                │
│  解説: この問題は○○についての...        │
│                                         │
│  ■ 第2問【第29回 午前】 ✗ 不正解        │
│  回答時間: 1分10秒                      │
│  ─────────────────────────────          │
│  問題: △△の特徴として誤っているものは   │
│  あなたの回答: b                        │
│  正解: d                                │
│  解説: △△の特徴としては...             │
│                                         │
│  ... (以下続く)                         │
│                                         │
│          [ PDFで保存 ]                  │
└─────────────────────────────────────────┘
```

### 14.12 PDF出力レイアウト（1ページ版）
```
┌─────────────────────────────────────────────────────────────────┐
│  国家試験対策 学習結果レポート          2024年1月15日 14:30     │
├─────────────────────────────────────────────────────────────────┤
│  【総合成績】出題数:50問 | 正答:38問 | 誤答:12問 | 正答率:76.0% │
│  【時間】総回答時間:25分30秒 | 平均:30.6秒/問                   │
├─────────────────────────────────────────────────────────────────┤
│  No. │ 出典          │ 結果 │ 回答 │ 正解 │ 時間  │ 解説(要約) │
├─────────────────────────────────────────────────────────────────┤
│  1   │ 29回午前-15   │ ✓   │ c    │ c    │ 25秒  │ ○○について │
│  2   │ 29回午前-16   │ ✗   │ b    │ d    │ 1:10  │ △△の特徴は │
│  3   │ 29回午後-3    │ ✓   │ a    │ a    │ 45秒  │ □□では...  │
│  ... │ ...           │ ...  │ ...  │ ...  │ ...   │ ...        │
│  50  │ 31回午後-8    │ ✓   │ e    │ e    │ 30秒  │ ◇◇を考慮  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 15. データ構造

### 15.1 問題データ（Question）
```typescript
interface Question {
  id: string;                    // ユニークID（例: "29-gozen-15"）
  year: number;                  // 年度（2021, 2022, ...）
  examNumber: number;            // 回次（29, 30, 31, 32, 33）
  session: 'gozen' | 'gogo';     // 午前 or 午後
  questionNumber: number;        // 問題番号
  questionText: string;          // 問題文
  choices: Choice[];             // 選択肢配列
  correctAnswer: string;         // 正解（a, b, c, d, e）
  explanation: string;           // 解説文
  sourceFile: string;            // 元PDFファイル名
  
  // 別冊関連
  hasSupplementImage: boolean;   // 別冊画像参照の有無
  supplementReferences: SupplementReference[];  // 別冊参照情報
}

interface Choice {
  label: string;                 // 選択肢ラベル（a, b, c...）
  text: string;                  // 選択肢の内容
}

interface SupplementReference {
  referenceText: string;         // 参照テキスト（例: "別冊No.12A"）
  supplementId: string;          // 別冊画像ID（例: "29-gogo-12A"）
  imageNumber: string;           // 画像番号（例: "12A", "図B"）
}
```

### 15.2 別冊データ（Supplement）
```typescript
interface Supplement {
  id: string;                    // ユニークID（例: "29-gogo-12A"）
  year: number;                  // 年度
  examNumber: number;            // 回次（29, 30, 31, 32, 33）
  session: 'gozen' | 'gogo';     // 午前 or 午後
  imageNumber: string;           // 画像番号（No.1, 図A, No.12A等）
  imageData: string;             // Base64エンコード画像 or ファイルパス
  imageType: 'ct' | 'xray' | 'photo' | 'ecg' | 'graph' | 'table' | 'other';
  caption: string;               // キャプション（あれば）
  relatedImages: string[];       // 関連画像ID（A, B, Cなど）
  sourceFile: string;            // 元別冊PDFファイル名
  sourcePage: number;            // 別冊PDF内のページ番号
}
```

### 15.3 回答データ（Answer）
```typescript
interface Answer {
  questionId: string;            // 対応する問題ID
  selectedAnswer: string | null; // ユーザーが選択した回答（未回答はnull）
  isCorrect: boolean;            // 正誤判定
  status: 'answered' | 'skipped' | 'timeout';  // 回答状態
  timeSpent: number;             // 回答時間（秒）- スキップ/時間切れは0
  answeredAt: Date | null;       // 回答日時（未回答はnull）
}

// 回答状態の説明:
// - answered: 選択肢を選んで回答した
// - skipped: ユーザーが意図的にスキップした（テストモードのみ）
// - timeout: 制限時間内に到達できなかった（テストモードのみ）
```

### 15.4 セッションデータ（Session）
```typescript
interface Session {
  id: string;                    // セッションID
  mode: 'learning' | 'test';     // モード（学習 or テスト）
  startedAt: Date;               // 開始日時
  finishedAt: Date;              // 終了日時
  settings: SessionSettings;     // 出題設定
  answers: Answer[];             // 回答データ配列
  summary: SessionSummary;       // 結果サマリー
  
  // テストモード専用
  timeLimit?: number;            // 制限時間（秒）
  remainingTime?: number;        // 残り時間（秒）- 完了時の残り
  isTimeUp?: boolean;            // 時間切れフラグ
}

interface SessionSettings {
  mode: 'learning' | 'test';     // モード
  examNumbers: number[];         // 選択した回次
  sessions: ('gozen' | 'gogo')[]; // 選択した時間帯
  questionCount: number;         // 出題数
  shuffle: boolean;              // シャッフル有無
  
  // テストモード専用
  timeLimit?: number;            // 制限時間（秒）= 問題数 × 75
}

interface SessionSummary {
  totalQuestions: number;        // 総出題数
  correctCount: number;          // 正答数
  incorrectCount: number;        // 誤答数
  skippedCount: number;          // スキップ数（テストモード用）
  timeoutCount: number;          // 時間切れ未回答数（テストモード用）
  answeredCount: number;         // 回答済み問題数（総問題数 - スキップ - 時間切れ）
  accuracy: number;              // 正答率（%）= 正答数 ÷ 回答済み問題数 × 100
  totalTime: number;             // 総回答時間（秒）
  averageTime: number;           // 平均回答時間（秒）
  
  // テストモード専用
  remainingTime?: number;        // 残り時間（秒）
  isTimeUp?: boolean;            // 時間切れフラグ
}
```

### 15.5 ヒントデータ（学習モード用）
```typescript
interface QuestionHint {
  questionId: string;            // 対応する問題ID
  keywords: string[];            // キーワード（問題文+解説から抽出）
  hints: string[];               // ヒント（正解に導くフレーズ）
}
```

---

## 16. 技術要件

### 16.1 PDF解析
- ライブラリ候補: pdf.js, pdf-parse, pdfjs-dist
- 日本語テキストの正確な抽出
- 問題構造の自動認識（問題番号、選択肢、解説のパターンマッチング）

### 16.2 別冊画像処理
- PDFからの画像抽出: pdf-poppler, pdf2pic, sharp
- 画像番号の自動認識: OCR（Tesseract.js）または位置ベースの解析
- 画像フォーマット: PNG形式で保存（高品質維持）
- 画像最適化: 表示用リサイズ + オリジナル保持（拡大表示用）
- 画像キャッシュ: 抽出済み画像をローカルに保存し再利用

### 16.3 データ保存
- ローカルDB: SQLite / IndexedDB
- 問題データのキャッシュ（毎回PDFを解析しない）
- セッション履歴の保存（オプション）

### 16.4 PDF出力
- ライブラリ候補: jsPDF, pdfmake, react-pdf
- 日本語フォント対応（Noto Sans JP等）
- A4サイズ、1ページレイアウト対応
- テキストベースPDF（画像ではなく検索・コピー可能）

### 16.5 UI/UX
- レスポンシブデザイン（デスクトップ最適化、タブレット対応）
- キーボードショートカット対応（1-5キーで選択肢選択など）
- ダークモード対応（オプション）

### 16.6 キーワード・ヒント抽出（学習モード用）
- 自然言語処理ライブラリ: kuromoji.js（形態素解析）
- 医学用語辞書との照合
- TF-IDF等による重要語抽出
- 解説文からのヒントフレーズ抽出

---

## 17. 非機能要件

### 17.1 パフォーマンス
- PDF読み込み: 100問あたり10秒以内
- 問題表示: 100ms以内
- PDF出力: 5秒以内
- タイマー精度: 1秒以内の誤差

### 17.2 データ保全
- セッション中断時のデータ保持
- PDF出力失敗時のリトライ機能
- テストモード中断時の回答データ保持

### 17.3 ユーザビリティ
- 直感的なUI（説明不要で操作可能）
- エラーメッセージの日本語対応
- 進捗の可視化
- 残り時間の視覚的フィードバック（色変化）

---

## 18. 開発優先順位

### Phase 1（MVP - 学習モード基本）
1. PDFフォルダ読み込み・ファイル名解析
2. 問題データ抽出
3. 基本的な出題設定（回次選択、時間帯選択、出題数指定）
4. 問題表示・回答機能（学習モード）
5. 1問ごとの時間計測
6. 1問ごとの正誤判定・解説表示
7. 結果サマリー表示

### Phase 2（別冊対応）
1. 別冊PDFからの画像抽出
2. 別冊番号の自動認識
3. 問題文からの別冊参照検出
4. 問題-別冊の自動紐付け（examNumber + session + imageNumber）
5. 問題画面での別冊画像表示
6. 画像拡大・ズーム機能

### Phase 3（学習モード完成）
1. キーワード・ヒント自動抽出機能
2. 「ヒントを見る」ボタン実装
3. 詳細レポート表示
4. PDF出力機能（1ページレイアウト）

### Phase 4（テストモード）
1. モード選択UI
2. 制限時間計算（問題数 × 75秒）
3. カウントダウンタイマー（残り時間表示）
4. 残り時間による色変化（緑→黄→オレンジ→赤）
5. 時間切れ時の強制終了処理
6. 未回答の別カウント処理
7. テストモード用結果画面（残り時間表示含む）

### Phase 5（拡張機能）
1. シャッフル機能
2. セッション履歴保存
3. 学習進捗管理（オプション）

---

## 19. 確認事項・前提条件

### 16.1 自動検出の前提条件
**以下はCursor側で全て自動処理する。ユーザーの手動作業は不要。**

| 処理 | 自動化方法 |
|------|-----------|
| 年度の判別 | ファイル名の先頭4桁から抽出 |
| 回次の判別 | ファイル名の2番目の数字から抽出 |
| 午前/午後の判別 | ファイル名の gozen/gogo から判別 |
| 別冊かどうかの判別 | ファイル名に _bessatsu があるか |
| 問題番号の抽出 | PDF内テキストから正規表現で抽出 |
| 別冊画像番号の認識 | OCR または PDF内テキストから抽出 |
| 問題と別冊の紐付け | examNumber + session + imageNumber の3条件で自動マッチング |

### 16.2 ファイル命名規則（必須）
```
必須パターン:
  {年度}_{回次}_{時間帯}.pdf
  {年度}_{回次}_{時間帯}_bessatsu.pdf

正規表現:
  /(\d{4})_(\d+)_(gozen|gogo)(_bessatsu)?\.pdf/

例:
  2021_29_gozen.pdf          ✓
  2021_29_gozen_bessatsu.pdf ✓
  2021_29_gogo.pdf           ✓
  2021_29_gogo_bessatsu.pdf  ✓
  
  第29回_午前.pdf            ✗ （パターン不一致）
  29_gozen.pdf               ✗ （年度がない）
```

### 16.3 PDFの構造確認が必要（Cursorが自動解析）
- [ ] 実際のPDFファイルの構造を確認
- [ ] 問題・選択肢・正解・解説の区切りパターンを特定
- [ ] 文字化けやレイアウト崩れの有無を確認

### 16.4 別冊PDFの構造確認が必要（Cursorが自動解析）
- [ ] 別冊内の画像番号の形式を確認（No.1、図A、写真1 など）
- [ ] 1ページに複数画像があるか、1画像1ページか
- [ ] 画像番号がテキストとして抽出可能か、画像内に埋め込まれているか
- [ ] 複数画像（A, B, C等）の配置パターンを確認
- [ ] 画像の解像度・品質を確認

### 16.5 ユーザー確認事項
- [ ] 選択肢の形式（a,b,c,d,e または 1,2,3,4,5 など）
- [ ] 複数正解問題の有無
- [ ] 別冊の内容 → **資料集（画像参照用）と確認済み**
- [ ] 午前の問題は午前の別冊のみ参照 → **確認済み**
- [ ] 午後の問題は午後の別冊のみ参照 → **確認済み**

---

## 20. 補足

### 17.1 NotebookLM対応について
PDFをNotebookLMで解析するため、以下の点に注意：
- テキストは画像化せず、テキストデータとして埋め込む
- 構造化されたフォーマット（テーブル形式）を維持
- 適切な見出し・区切りを設定
- ファイルサイズは軽量に（不要な装飾を避ける）

### 17.2 将来的な拡張案
- クラウド同期機能
- 学習履歴の統計分析
- 苦手分野の自動抽出
- 模擬試験モード（制限時間付き）
- 他ユーザーとの成績比較

---

**作成日**: 2025年1月18日  
**バージョン**: 3.1（スキップ機能・自動遷移機能追加）
